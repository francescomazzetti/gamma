<!DOCTYPE html>
<html lang="it">

<head>
<meta charset="UTF-8">
<script type="text/javascript" th:src="@{/js/jquery-3.7.1.min.js}"></script>
<title>Index</title>
<script type="text/javascript" th:inline="javascript">
    	/*<![CDATA[*/
   		var status = /*[[${status}]]*/ '';
		var url = /*[[${url}]]*/ '';
		var client_id = /*[[${client_id}]]*/ '';
		var grant_type = /*[[${grant_type}]]*/ '';
		var code = /*[[${code}]]*/ '';
    	/*]]>*/
		var at = "";
		var username = "";
		
		$(function(){
				if (status == "logged_out" || status==null) {
					console.log("logged_out");
					$('#auth-div').show();
				}
				else if (status == "azcode") {
					var formData = {
		                'code': code,
						'client_id': client_id,
						'grant_type': grant_type
		            };
					$.ajax({
					      type: 'POST',
					      url: url,
					      data: formData,
					      dataType: "text",
					      success: function(resultData) {
							console.log(resultData);
							var resultDataJson = $.parseJSON(resultData);
							if (resultDataJson.error == null) {
								$.ajax({
								      type: 'POST',
								      url: "/gamma-service-orchestrator/init-session",
								      data: resultDataJson,
								      dataType: "json",
								      success: function(resultData) {
										if (resultData.status == "ok") {
											at = resultData.accessToken;
											username = resultData.username;
											$('#pusername').html(username);
											$('#postlogin-div').show();
											
										}
									}
								});
							}
						}
					});
				}
		});
    </script>
</head>

<body>
	<div id="auth-div" style="display: none;">
		<h2>Non hai ancora eseguito l'accesso</h2>
		<div>
			<form id="loginform" th:action="${url}" method="GET">
				<input name="state" id="state" type="hidden" th:value="${state}" />
				<input name="scope" id="scope" type="hidden" th:value="${scope}" />
				<input name="redirect_uri" id="redirect_uri" type="hidden" th:value="${redirect_uri}" />
				<input name="client_id" id="client_id" type="hidden" th:value="${client_id}" />
				<input type="submit" value="Richiedi Autenticazione" />
			</form>
		</div>
	</div>
	<div id="azcode-div">
		<form id="tokenform" th:action="${url}" method="POST">
			<input name="code" id="code" type="hidden" th:value="${code}" />
			<input name="grant_type" id="scope" type="hidden" th:value="${scope}" />
			<input name="redirect_uri" id="redirect_uri" type="hidden" th:value="${redirect_uri}" />
			<input name="client_id" id="client_id" type="hidden" th:value="${client_id}" />
		</form>
	</div>
	<div id="postlogin-div" style="display: none;">
			<h2>Benvenuto <div id="pusername"></div></h2>
			Clicca per vedere le tue caselle PEC
			<input type="button" id="pec-load" value="Prosegui" />
		</div>
</body>

</html>